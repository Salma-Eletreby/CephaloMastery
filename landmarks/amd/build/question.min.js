/**
 * Question class for drag and drop marker question type, used to support the question and preview pages.
 *
 * @module     qtype_landmarks/question
 * @copyright  2018 The Open University
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define(["jquery","core/dragdrop","qtype_landmarks/shapes","core/key_codes","core_form/changechecker"],function(e,t,o,a,i){"use strict";function n(e,t,o){var a=this;this.containerId=e,this.visibleDropZones=o,this.shapes=[],this.shapeSVGs=[],this.isPrinting=!1,this.questionAnswer={},t&&this.getRoot().addClass("qtype_landmarks-readonly"),a.allImagesLoaded=!1,a.getNotYetLoadedImages().one("load",function(){a.waitForAllImagesToBeLoaded()}),a.waitForAllImagesToBeLoaded()}n.prototype.drawDropzones=function(){if(this.visibleDropZones.length>0){var e=this.bgImage();this.getRoot().find("div.dropzones").html('<svg xmlns="http://www.w3.org/2000/svg" class="dropzones" width="'+e.outerWidth()+'" height="'+e.outerHeight()+'"></svg>');for(var t=this.getRoot().find("svg.dropzones"),o=0,a=0;a<this.visibleDropZones.length;a++){var i="color"+o;o=(o+1)%8,this.addDropzone(t,a,i)}}},n.prototype.addDropzone=function(e,t,a){var i,n=this.visibleDropZones[t],s=o.make(n.shape,""),r=this.bgRatio();if(s.parse(n.coords,r)){if((i=this.getRoot().find("div.markertexts span.markertext"+t)).length)""!==n.markertext?i.html(n.markertext):i.remove();else if(""!==n.markertext){this.getRoot().find("div.markertexts").append('<span class="markertext markertext'+t+'">'+n.markertext+"</span>");var d=this.getRoot().find("div.ddarea div.markertexts span.markertext"+t);if(d.length){var g=s.getHandlePositions(),h=g.moveHandle.x-d.outerWidth()/2-4,l=g.moveHandle.y-d.outerHeight()/2;d.css("left",h).css("top",l),d.data("originX",d.position().left/r).data("originY",d.position().top/r),this.handleElementScale(d,"center")}}var f=s.makeSvg(e[0]);f.setAttribute("class","dropzone "+a),this.shapes[this.shapes.length]=s,this.shapeSVGs[this.shapeSVGs.length]=f}},n.prototype.repositionDrags=function(){var t=this.getRoot(),o=this;t.find("div.draghomes .marker").not(".dragplaceholder").each(function(t,o){e(o).addClass("unneeded")}),t.find("input.choices").each(function(e,t){var a=o.getChoiceNoFromElement(t),i=o.getImageCoords(t);if(i.length){var n=o.getRoot().find(".draghomes span.marker.choice"+a).not(".dragplaceholder");n.remove();for(var s=0;s<i.length;s++){var r=n.clone();let d=o.convertToWindowXY(i[s]);r.data("pagex",d.x).data("pagey",d.y),r.data("imageCoords",i[s]),r.data("scaleRatio",1),o.sendDragToDrop(r,!1,!0)}o.getDragClone(n).addClass("active"),o.cloneDragIfNeeded(n)}}),o.questionAnswer=o.getQuestionAnsweredValues()},n.prototype.getQuestionAnsweredValues=function(){let e={};return this.getRoot().find("input.choices").each((t,o)=>{e[o.id]=o.value}),e},n.prototype.isQuestionInteracted=function(){let e=this.questionAnswer,t=this.getQuestionAnsweredValues(),o=!1;return JSON.stringify(t)!==JSON.stringify(e)?o=!0:(Object.keys(t).forEach(a=>{t[a]!==e[a]&&(o=!0)}),o)},n.prototype.getImageCoords=function(t){var a=[],i=e(t).val();if(""!==i)for(var n=i.split(";"),s=0;s<n.length;s++)a[s]=o.Point.parse(n[s]);return a},n.prototype.convertToWindowXY=function(e){var t=this.bgImage();return e.offset(t.offset().left+1,t.offset().top+1)},n.prototype.convertToBgImgXY=function(e){var t=this.bgImage();return e.offset(-t.offset().left-1,-t.offset().top-1)},n.prototype.coordsInBgImg=function(e){var t=this.bgImage(),o=t.offset();return e.x>=o.left&&e.x<o.left+t.width()&&e.y>=o.top&&e.y<o.top+t.height()},n.prototype.getRoot=function(){return e(document.getElementById(this.containerId))},n.prototype.bgImage=function(){return this.getRoot().find("img.dropbackground")},n.prototype.handleDragStart=function(o){var a=this,i=e(o.target).closest(".marker");if(t.prepare(o).start){if(i.addClass("beingdragged").css("transform",""),i.hasClass("unneeded")){var n=a.getDragClone(i);n.length&&(n.addClass("active"),i.offset(n.offset()))}t.start(o,i,function(){},function(e,t,o){a.dragEnd(o)})}},n.prototype.dragEnd=function(e){var t,a=!1,i=this.getChoiceNoFromElement(e),n=this.bgRatio();if(e.data("pagex",e.offset().left).data("pagey",e.offset().top),t=new o.Point(e.data("pagex"),e.data("pagey")),this.coordsInBgImg(t)){this.sendDragToDrop(e,!0),a=!0,e.data("imageCoords")&&e.data("imageCoords",null);var s=this.convertToBgImgXY(t);s=new o.Point(s.x/n,s.y/n),e.data("originX",s.x).data("originY",s.y)}a?this.cloneDragIfNeeded(e):(this.sendDragHome(e),this.removeDragIfNeeded(e)),this.saveCoordsForChoice(i)},n.prototype.saveCoordsForChoice=function(t){let a=[];var i=this.getRoot().find("div.droparea span.marker.choice"+t),n=this,r=this.bgRatio();i.length&&i.each(function(){var t=e(this);if(t.hasClass("beingdragged")||t.data("imageCoords"))t.data("imageCoords")&&(a[a.length]=t.data("imageCoords"));else{t.data("scaleRatio")!==r&&t.data("pagex",t.offset().left).data("pagey",t.offset().top);var i=new o.Point(t.data("pagex"),t.data("pagey"));if(n.coordsInBgImg(i)){var s=n.convertToBgImgXY(i);s=new o.Point(s.x/r,s.y/r),a[a.length]=s}}}),this.getRoot().find("input.choice"+t).val(a.join(";")),this.isQuestionInteracted()&&(s.handleFormDirty(),this.questionAnswer=this.getQuestionAnsweredValues())},n.prototype.handleKeyPress=function(t){var i=e(t.target).closest(".marker"),n=new o.Point(i.offset().left,i.offset().top),s=this.getChoiceNoFromElement(i);switch(t.keyCode){case a.arrowLeft:case 65:n.x-=1;break;case a.arrowRight:case 68:n.x+=1;break;case a.arrowDown:case 83:n.y+=1;break;case a.arrowUp:case 87:n.y-=1;break;case a.space:case a.escape:n=null;break;default:return}if(t.preventDefault(),null!==n){n=this.constrainToBgImg(n),i.offset({left:n.x,top:n.y}),i.data("pagex",i.offset().left).data("pagey",i.offset().top);var r=this.convertToBgImgXY(new o.Point(i.data("pagex"),i.data("pagey")));if(i.data("originX",r.x/this.bgRatio()).data("originY",r.y/this.bgRatio()),this.coordsInBgImg(new o.Point(i.offset().left,i.offset().top))&&i.hasClass("unneeded")){this.sendDragToDrop(i,!0);var d=this.getDragClone(i);d.length&&d.addClass("active"),this.cloneDragIfNeeded(i)}}else i.css("left","").css("top",""),i.data("pagex",i.offset().left).data("pagey",i.offset().top),this.sendDragHome(i),this.removeDragIfNeeded(i);i.focus(),this.saveCoordsForChoice(s)},n.prototype.constrainToBgImg=function(e){var t=this.bgImage(),o=this.convertToBgImgXY(e);return o.x=Math.max(0,o.x),o.y=Math.max(0,o.y),o.x=Math.min(t.width(),o.x),o.y=Math.min(t.height(),o.y),this.convertToWindowXY(o)},n.prototype.getChoiceNoFromElement=function(e){return Number(this.getClassnameNumericSuffix(e,"choice"))},n.prototype.getClassnameNumericSuffix=function(t,o){var a=e(t).attr("class");if(void 0!==a&&""!==a){for(var i=a.split(" "),n=0;n<i.length;n++)if(RegExp("^"+o+"([0-9])+$").test(i[n]))return Number(RegExp("([0-9])+$").exec(i[n])[0])}return null},n.prototype.handleResize=function(){var t=this,o=this.bgRatio();this.isPrinting&&(o=1),this.getRoot().find("div.droparea .marker").not(".beingdragged").each(function(a,i){e(i).css("left",parseFloat(e(i).data("originX"))*parseFloat(o)).css("top",parseFloat(e(i).data("originY"))*parseFloat(o)),t.handleElementScale(i,"left top")}),this.getRoot().find("div.droparea svg.dropzones").width(this.bgImage().width()).height(this.bgImage().height());for(var a=0;a<this.visibleDropZones.length;a++){var i=t.visibleDropZones[a].coords,n=t.shapes[a],s=t.shapeSVGs[a];n.parse(i,o),n.updateSvg(s);var r=n.getHandlePositions(),d=this.getRoot().find("div.ddarea div.markertexts span.markertext"+a);d.css("left",r.moveHandle.x-d.outerWidth()/2-4).css("top",r.moveHandle.y-d.outerHeight()/2),t.handleElementScale(d,"center")}},n.prototype.cloneDrags=function(){var t=this;this.getRoot().find("div.draghomes span.marker").each(function(o,a){var i=e(a),n=i.clone();n.removeClass(),n.addClass("marker"),n.addClass("choice"+t.getChoiceNoFromElement(i)),n.addClass(t.getDragNoClass(i,!1)),n.addClass("dragplaceholder"),i.before(n)})},n.prototype.getDragNo=function(e){return this.getClassnameNumericSuffix(e,"dragno")},n.prototype.getDragNoClass=function(e,t){var o="dragno"+this.getDragNo(e);return(this.isInfiniteDrag(e)&&(o="infinite"),t)?"."+o:o},n.prototype.getDragClone=function(e){return this.getRoot().find(".draghomes span.marker.choice"+this.getChoiceNoFromElement(e)+this.getDragNoClass(e,!0)+".dragplaceholder")},n.prototype.dropArea=function(){return this.getRoot().find("div.droparea")},n.prototype.sendDragHome=function(e){e.removeClass("beingdragged").addClass("unneeded").css("top","").css("left","").css("transform","");var t=this.getDragClone(e);t.after(e),t.removeClass("active")},n.prototype.sendDragToDrop=function(e,t,a=!1){var i=this.dropArea(),n=this.bgRatio();e.removeClass("beingdragged").removeClass("unneeded");var s=this.convertToBgImgXY(new o.Point(e.data("pagex"),e.data("pagey")));t?(e.data("originX",s.x/n).data("originY",s.y/n),e.css("left",s.x).css("top",s.y)):(e.data("originX",s.x).data("originY",s.y),e.css("left",s.x*n).css("top",s.y*n)),a||e.data("scaleRatio",n),i.append(e),this.handleElementScale(e,"left top")},n.prototype.cloneDragIfNeeded=function(e){var t=this.getInput(e),o=Number(this.getClassnameNumericSuffix(t,"noofdrags")),a=this.getRoot().find("div.droparea .marker.choice"+this.getChoiceNoFromElement(e)+this.getDragNoClass(e,!0)).length,i=this.getRoot().find("div.draghomes .marker.choice"+this.getChoiceNoFromElement(e)+this.getDragNoClass(e,!0)).not(".dragplaceholder").length;if((this.isInfiniteDrag(e)||!this.isInfiniteDrag(e)&&a<o)&&0===i){var n=e.clone();n.addClass("unneeded").css("top","").css("left","").css("transform",""),this.getDragClone(e).removeClass("active").after(n),s.addEventHandlersToMarker(n)}},n.prototype.removeDragIfNeeded=function(e){for(var t=this.getRoot().find("div.draghomes .marker.choice"+this.getChoiceNoFromElement(e)+this.getDragNoClass(e,!0)).not(".dragplaceholder"),o=t.length;o>1;)t.first().remove(),o--},n.prototype.getInput=function(e){var t=this.getChoiceNoFromElement(e);return this.getRoot().find("input.choices.choice"+t)},n.prototype.bgRatio=function(){var e=this.bgImage(),t=e.get(0).naturalWidth;return e.width()/t},n.prototype.handleElementScale=function(t,o){var a=parseFloat(this.bgRatio());this.isPrinting&&(a=1),e(t).css({"-webkit-transform":"scale("+a+")","-moz-transform":"scale("+a+")","-ms-transform":"scale("+a+")","-o-transform":"scale("+a+")",transform:"scale("+a+")","transform-origin":o})},n.prototype.isInfiniteDrag=function(e){return e.hasClass("infinite")},n.prototype.waitForAllImagesToBeLoaded=function(){if(!this.allImagesLoaded){if(null!==this.imageLoadingTimeoutId&&clearTimeout(this.imageLoadingTimeoutId),this.getNotYetLoadedImages().length>0){this.imageLoadingTimeoutId=setTimeout(function(){this.waitForAllImagesToBeLoaded()},100);return}this.allImagesLoaded=!0,this.cloneDrags(),this.repositionDrags(),this.drawDropzones()}},n.prototype.getNotYetLoadedImages=function(){return this.getRoot().find(".landmarks img.dropbackground").not(function(e,t){return this.imageIsLoaded(t)})},n.prototype.imageIsLoaded=function(e){return e.complete&&0!==e.naturalHeight};var s={eventHandlersInitialised:!1,markerEventHandlersInitialised:{},isPrinting:!1,isKeyboardNavigation:!1,questions:{},init:function(t,o,a){if(s.questions[t]=new n(t,o,a),s.eventHandlersInitialised||(s.setupEventHandlers(),s.eventHandlersInitialised=!0),!s.markerEventHandlersInitialised.hasOwnProperty(t)){s.markerEventHandlersInitialised[t]=!0;var i=document.getElementById(t);i.classList.contains("landmarks")&&!i.classList.contains("qtype_landmarks-readonly")&&(s.addEventHandlersToMarker(e(i).find("div.draghomes .marker")),s.addEventHandlersToMarker(e(i).find("div.droparea .marker")))}},setupEventHandlers:function(){e(window).on("resize",function(){s.handleWindowResize(!1)}),window.addEventListener("beforeprint",function(){s.isPrinting=!0,s.handleWindowResize(s.isPrinting)}),window.addEventListener("afterprint",function(){s.isPrinting=!1,s.handleWindowResize(s.isPrinting)}),setTimeout(function(){s.fixLayoutIfThingsMoved()},100)},addEventHandlersToMarker:function(e){e.on("mousedown touchstart",s.handleDragStart).on("keydown keypress",s.handleKeyPress).focusin(function(e){s.handleKeyboardFocus(e,!0)}).focusout(function(e){s.handleKeyboardFocus(e,!1)})},handleDragStart:function(e){e.preventDefault();var t=s.getQuestionForEvent(e);t&&t.handleDragStart(e)},handleKeyPress:function(e){var t=s.getQuestionForEvent(e);t&&t.handleKeyPress(e)},handleWindowResize:function(e){for(var t in s.questions)s.questions.hasOwnProperty(t)&&(s.questions[t].isPrinting=e,s.questions[t].handleResize())},handleKeyboardFocus:function(e,t){s.isKeyboardNavigation=t},fixLayoutIfThingsMoved:function(){s.isKeyboardNavigation||this.handleWindowResize(s.isPrinting),setTimeout(function(){s.fixLayoutIfThingsMoved(s.isPrinting)},100)},getQuestionForEvent:function(t){var o=e(t.currentTarget).closest(".que.landmarks").attr("id");return s.questions[o]},handleFormDirty:function(){let e=document.getElementById("responseform");i.markFormAsDirty(e)}};return{init:s.init}});

//# sourceMappingURL=question.min.js.map