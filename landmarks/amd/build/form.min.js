/**
 * This class provides the enhancements to the drag-drop marker editing form.
 *
 * @module     qtype_landmarks/form
 * @copyright  23/24 SDP<group_31_CS_F>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */ define(["jquery","core/dragdrop","qtype_landmarks/shapes"],function(e,t,o){"use strict";function r(e){this.dropzoneNo=e,this.svgEl=null,this.shape=o.make(this.getShapeType(),this.getLabel()),this.updateCoordinatesFromForm()}r.prototype.updateCoordinatesFromForm=function(e){var t=this.getCoordinates(),o="polygon"===this.shape.getType()&&this.shape.points.length;if(this.shape.getCoordinates()!==t&&this.shape.parse(t,1)){if("polygon"===this.shape.getType()&&o!==this.shape.points.length){var r=this.isActive();this.removeFromSvg(),e&&(this.addToSvg(e),r&&this.setActive())}else this.updateSvgEl();this.setCoordinatesInForm()}},r.prototype.updateLabel=function(){var e=this.getLabel();this.shape.label!==e&&(this.shape.label=e,this.updateSvgEl())},r.prototype.changeShape=function(e){var t=this.getShapeType(),r=this.isActive();t!==this.shape.getType()&&(this.removeFromSvg(),this.shape=o.getSimilar(t,this.shape),e&&(this.addToSvg(e),r&&this.setActive()),this.setCoordinatesInForm())},r.prototype.addToSvg=function(e){if(null!==this.svgEl)throw Error("this.svgEl already set");if(this.svgEl=this.shape.makeSvg(e),this.svgEl){this.svgEl.setAttribute("class","dropzone"),this.svgEl.setAttribute("data-dropzone-no",this.dropzoneNo);var t=this.shape.getHandlePositions();if(null!==t){var r=o.createSvgElement(this.svgEl,"circle");r.setAttribute("cx",t.moveHandle.x),r.setAttribute("cy",t.moveHandle.y),r.setAttribute("r",7),r.setAttribute("class","handle move");for(var i=0;i<t.editHandles.length;++i)this.makeEditHandle(i,t.editHandles[i])}}},r.prototype.makeEditHandle=function(e,t){var r=o.createSvgElement(this.svgEl,"rect");r.setAttribute("x",t.x-6),r.setAttribute("y",t.y-6),r.setAttribute("width",11),r.setAttribute("height",11),r.setAttribute("class","handle edit"),r.setAttribute("data-edit-handle-no",e)},r.prototype.removeFromSvg=function(){null!==this.svgEl&&(this.svgEl.parentNode.removeChild(this.svgEl),this.svgEl=null)},r.prototype.updateSvgEl=function(){if(null!==this.svgEl){this.shape.updateSvg(this.svgEl);var e=this.shape.getHandlePositions();if(null!==e){this.svgEl.childNodes[2].setAttribute("cx",e.moveHandle.x),this.svgEl.childNodes[2].setAttribute("cy",e.moveHandle.y);for(var t=0;t<e.editHandles.length;++t)this.svgEl.childNodes[3+t].setAttribute("x",e.editHandles[t].x-6),this.svgEl.childNodes[3+t].setAttribute("y",e.editHandles[t].y-6)}}},r.prototype.isActive=function(){return null!==this.svgEl&&this.svgEl.getAttribute("class").match(/\bactive\b/)},r.prototype.setActive=function(){var e=this.svgEl.parentNode;e.removeChild(this.svgEl),e.appendChild(this.svgEl),this.svgEl.setAttribute("class",this.svgEl.getAttribute("class")+" active")},r.prototype.setCoordinatesInForm=function(){i.form.setFormValue("drops",[this.dropzoneNo,"coords"],this.shape.getCoordinates())},r.prototype.getCoordinates=function(){return i.form.getFormValue("drops",[this.dropzoneNo,"coords"]).replace(/\s*/g,"")},r.prototype.getChoiceNo=function(){return i.form.getFormValue("drops",[this.dropzoneNo,"choice"])},r.prototype.getLabel=function(){return i.form.getMarkerText(this.getChoiceNo())},r.prototype.getShapeType=function(){return i.form.getFormValue("drops",[this.dropzoneNo,"shape"])},r.prototype.handleMove=function(o){var r=t.prepare(o);if(r.start){var i=this,n=r.x,a=r.y,s=this.makeDragProxy(r.x,r.y),d=e("fieldset#id_previewareaheader .dropbackground"),l=d.width(),p=d.height();t.start(o,e(s),function(e,t){i.shape.move(e-n,t-a,l,p),n=e,a=t,i.updateSvgEl(),i.setCoordinatesInForm()},function(){document.body.removeChild(s)})}},r.prototype.handleEdit=function(o,r,i){var n=t.prepare(o);if(n.start){"polygon"===this.shape.getType()&&(o.ctrlKey||o.metaKey)&&(this.shape.addNewPointAfter(r),this.removeFromSvg(),this.addToSvg(i),this.setActive());var a=this,s=n.x,d=n.y,l=this.makeDragProxy(n.x,n.y),p=e("fieldset#id_previewareaheader .dropbackground"),g=p.width(),h=p.height();t.start(o,e(l),function(e,t){a.shape.edit(r,e-s,t-d,g,h),s=e,d=t,a.updateSvgEl(),a.setCoordinatesInForm()},function(){document.body.removeChild(l),a.shape.normalizeShape(),a.updateSvgEl(),a.setCoordinatesInForm()})}},r.prototype.makeDragProxy=function(e,t){var o=document.createElement("div");return o.style.position="absolute",o.style.top=t+"px",o.style.left=e+"px",o.style.width="1px",o.style.height="1px",document.body.appendChild(o),o};var i={fp:null,noDropZones:null,dropZones:[],init:function(){i.fp=i.filePickers(),i.noDropZones=i.form.getFormValue("nodropzone",[]),i.setOptionsForDragItemSelectors(),i.createShapes(),i.setupEventHandlers(),i.waitForFilePickerToInitialise()},setupPreviewArea:function(){e("fieldset#id_previewareaheader div.fcontainer").append('<div class="ddarea que landmarks">   <div id="ddm-droparea" class="droparea">       <img class="dropbackground" />       <div id="ddm-dropzone" class="dropzones">       </div>   </div></div>')},setOptionsForDragItemSelectors:function(){var t,o,r,n,a,s,d,l,p={0:""},g=i.form.getFormValue("noitems",[]),h=[],c=[],f=[],u=[],v=[],m=[];for(d=1;d<=g;d++)""!==(l=i.form.getMarkerText(d))&&(p[d]=e("<div/>").text(l).html());for(d=0;d<i.noDropZones;d++)t=e("#id_drops_"+d+"_choice"),h[d]=Number(t.val());for(d=0;d<25;d++)if(o=e("#id_dd_"+d+"_point1"),r=e("#id_dd_"+d+"_point2"),o&&r)c[d]=Number(o.val()),f[d]=Number(r.val());else break;for(d=0;d<25;d++)if(n=e("#id_angles_"+d+"_point1"),a=e("#id_angles_"+d+"_point2"),s=e("#id_angles_"+d+"_point3"),n&&a&&s)u[d]=Number(n.val()),v[d]=Number(a.val()),m[d]=Number(s.val());else break;for(d=0;d<i.noDropZones;d++){for(var y in(t=e("#id_drops_"+d+"_choice")).find("option").remove(),p){var b='<option value="'+(y=Number(y))+'">'+p[y]+"</option>";t.append(b);var $=t.find('option[value="'+y+'"]');if(0!==y){if(y===h[d]){$.attr("selected",!0);continue}var E=i.form.getFormValue("drags",[y-1,"noofdrags",]);if(0!==Number(E)){for(var _ in h)if(Number(h[_])===y){if(1===Number(E)){$.attr("disabled",!0);break}E--}}}}i.dropZones.length>0&&i.dropZones[d].updateLabel()}for(d=0;d<=25;d++)if(o=e("#id_dd_"+d+"_point1"),r=e("#id_dd_"+d+"_point2"),o&&r)for(var y in o.find("option").remove(),r.find("option").remove(),p){var b='<option value="'+(y=Number(y))+'">'+p[y]+"</option>";o.append(b),r.append(b);var k=o.find('option[value="'+y+'"]'),F=r.find('option[value="'+y+'"]');0!==y&&(y===c[d]&&k.attr("selected",!0),y===f[d]&&F.attr("selected",!0))}else break;for(d=0;d<=25;d++)if(n=e("#id_angles_"+d+"_point1"),a=e("#id_angles_"+d+"_point2"),s=e("#id_angles_"+d+"_point3"),n&&a&&s)for(var y in n.find("option").remove(),a.find("option").remove(),s.find("option").remove(),p){var b='<option value="'+(y=Number(y))+'">'+p[y]+"</option>";n.append(b),a.append(b),s.append(b);var S=n.find('option[value="'+y+'"]'),w=a.find('option[value="'+y+'"]'),I=s.find('option[value="'+y+'"]');0!==y&&(y===u[d]&&S.attr("selected",!0),y===v[d]&&w.attr("selected",!0),y===m[d]&&I.attr("selected",!0))}else break},createShapes:function(){for(var e=0;e<i.noDropZones;e++)i.dropZones[e]=new r(e)},setupEventHandlers:function(){e("fieldset#id_draggableitemheader").on("change input","input, select",function(){i.setOptionsForDragItemSelectors()}),e("fieldset#id_dropzoneheader").on("change input","input, select",function(e){var t=e.currentTarget.name.match(/^drops\[(\d+)]\[([a-z]*)]$/);if(t){var o=t[1],r=t[2],n=i.dropZones[o];switch(r){case"shape":n.changeShape(i.form.getSvg());break;case"coords":n.updateCoordinatesFromForm(i.form.getSvg());break;case"choice":n.updateLabel()}}});var t=e("fieldset#id_previewareaheader");t.on("click","g.dropzone",function(t){var o=e(t.currentTarget).data("dropzone-no"),r=i.dropZones[o].isActive();e(i.form.getSvg()).find(".dropzone.active").removeClass("active"),r||i.dropZones[o].setActive()}),t.on("mousedown touchstart",".dropzone .handle.move",function(t){var o=e(t.currentTarget).closest("g").data("dropzoneNo");i.dropZones[o].handleMove(t)}),t.on("mousedown touchstart",".dropzone .handle.edit",function(t){var o=e(t.currentTarget).closest("g").data("dropzoneNo"),r=t.currentTarget.getAttribute("data-edit-handle-no");i.dropZones[o].handleEdit(t,r,i.form.getSvg())})},waitForFilePickerToInitialise:function(){if(null===i.fp.file("bgimage").href){setTimeout(i.waitForFilePickerToInitialise,1e3);return}e('form.mform[data-qtype="landmarks"]').on("change","#id_bgimage",i.loadPreviewImage),e("#ddm-droparea").length||i.setupPreviewArea(),i.loadPreviewImage()},loadPreviewImage:function(){e("fieldset#id_previewareaheader .dropbackground").one("load",i.afterPreviewImageLoaded).attr("src",i.fp.file("bgimage").href)},afterPreviewImageLoaded:function(){var t=e("fieldset#id_previewareaheader .dropbackground");e("#ddm-dropzone").css("position","relative").css("top",-((t.height()+1)*1)),e("#ddm-droparea").css("height",t.height()+20),i.updateSvgDisplay()},updateSvgDisplay:function(){var t,o=e("fieldset#id_previewareaheader .dropbackground");if(i.form.getSvg())for(t=0;t<i.noDropZones;t++)i.dropZones[t].updateSvgEl();else for(e("#ddm-dropzone").html('<svg xmlns="http://www.w3.org/2000/svg" class="dropzones" width="'+o.outerWidth()+'" height="'+o.outerHeight()+'"></svg>'),t=0;t<i.noDropZones;t++)i.dropZones[t].addToSvg(i.form.getSvg())},form:{getMarkerText:function(e){return 0===Number(e)?"":i.form.getFormValue("drags",[e-1,"label",]).replace(RegExp("^\\s*(.*)\\s*$"),"$1")},getSvg:function(){var t=e("fieldset#id_previewareaheader svg");return 0===t.length?null:t[0]},toNameWithIndex:function(e,t){for(var o=e,r=0;r<t.length;r++)o=o+"["+t[r]+"]";return o},getEl:function(t,o){return e('form.mform[data-qtype="landmarks"]')[0].elements[this.toNameWithIndex(t,o)]},getFormValue:function(e,t){var o=this.getEl(e,t);return"checkbox"===o.type?o.checked:o.value},setFormValue:function(e,t,o){var r=this.getEl(e,t);"checkbox"===r.type?r.checked=o:r.value=o},createPointsForm:function(e,t,o){var r=this.getEl(e,t);return r.value=o,i.setOptionsForDragItemSelectors(),r.value}},fillPointsUsingML:function(){var e=[];i.waitForFilePickerToInitialise();for(let t=0;t<e.length;++t)i.form.createPointsForm(e[t][0],e[t][1],e[t][2])},filePickers:function(){var t,o;return void 0===t&&(t={},o={},e("form.mform input.filepickerhidden").each(function(e,r){t[r.value]=r.name,o[r.name]=r.parentNode})),{file:function(t){var r=e(o[t]).find("div.filepicker-filelist a");return r.length?{href:r.get(0).href,name:r.get(0).innerHTML}:{href:null,name:null}},name:function(e){return t[e]}}}};let n=function(e){var t=[];for(let o=0;o<e.length;++o){var r=5*o;t[r]=["drags",[`${o}`,"label"],`${e[o].keypoint_name}`,],t[r+1]=["drags",[`${o}`,"noofdrags"],"1"],t[r+2]=["drops",[`${o}`,"shape"],"circle"],t[r+3]=["drops",[`${o}`,"choice"],`${o+1}`],t[r+4]=["drops",[`${o}`,"coords"],`${e[o].coordinates};15`,]}for(let n=0;n<t.length;++n)i.form.createPointsForm(t[n][0],t[n][1],t[n][2])};document.getElementById("id_generateML").onclick=function(){var e=document.getElementById("id_userToken").value;skipClientValidation=!0;var t=document.getElementById("id_generateML");t.innerHTML='<div class="loader" style="border: 4px solid rgba(0, 0, 0, 0.1); border-left-color: #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;">&nbsp;</div>';let o=document.getElementsByClassName("filepicker-filename")[0].querySelector("a").getAttribute("href"),r=o.replace("/draftfile.php/","/webservice/draftfile.php/")+"?token="+e;fetch("https://aitech.net.au/cephalo-mastery/ai/landmarks/get_points",{method:"POST",headers:{"Access-Control-Allow-Origin":"*"},body:r}).then(e=>{if(!e.ok)throw Error("Error occurred while fetching data");return e.json()}).then(e=>{n(e),t.innerHTML="Answer Retrieved Succesfully"}).catch(e=>{console.error(e.message),t.innerHTML="Connection failed.Check the token or image uploaded",document.getElementById("id_userToken").value=""})};let a=function(e){var t=[];for(let o=0;o<19;++o){var r=5*o;t[r]=["drags",[`${o}`,"label"],`${e.shapes[o].label}`,],t[r+1]=["drags",[`${o}`,"noofdrags"],"1"],t[r+2]=["drops",[`${o}`,"shape"],"circle"],t[r+3]=["drops",[`${o}`,"choice"],`${o+1}`],t[r+4]=["drops",[`${o}`,"coords"],`${e.shapes[o].points[0]};15`,]}for(let n=0;n<t.length;++n)i.form.createPointsForm(t[n][0],t[n][1],t[n][2])},s=document.getElementsByClassName("filepicker-filename")[1],d=new MutationObserver(e=>{e.forEach(e=>{"childList"===e.type&&e.addedNodes.forEach(e=>{if("a"===e.nodeName.toLowerCase()){var t=document.getElementById("fitem_id_JSONLoading");t.innerHTML='<div class="loader" id="loader" style="border: 4px solid rgba(0, 0, 0, 0.1); border-left-color: #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;">&nbsp;</div>',document.getElementById("loader").style.marginLeft="20rem",fetch(`${i.fp.file("jsonFile").href}`).then(e=>{if(!e.ok)throw Error("Network response was not ok");return e.json()}).then(e=>{a(e),t.innerHTML='<div id="loaded">Points Filled Succesfully</div>',document.getElementById("loaded").style.marginLeft="19rem"}).catch(e=>{console.error("There was a problem with the fetch operation:",e)})}})})});d.observe(s,{childList:!0});let l=function(e){let t=document.getElementById(`id_dd_${e}_point1`).value,o=document.getElementById(`id_dd_${e}_point2`).value;if("0"!=t&&"0"!=o){let r=i.form.getFormValue("drops",[t-1,"coords"]).replace(/\s*/g,"").toString().split(",")[0],n=i.form.getFormValue("drops",[o-1,"coords"]).replace(/\s*/g,"").toString().split(",")[0],a=i.form.getFormValue("drops",[t-1,"coords"]).replace(/\s*/g,"").toString().split(",")[1].split(";"),s=i.form.getFormValue("drops",[o-1,"coords"]).replace(/\s*/g,"").toString().split(",")[1].split(";"),d=Math.abs(n-r),l=Math.abs(parseFloat(s[0])-parseFloat(a[0])),p=Math.sqrt(Math.abs(d*d+l*l));isNaN(p)&&(p=0),document.getElementById(`id_dd_${e}_distance`).value=p,document.getElementById("id_generalfeedback_ifr").contentDocument.querySelector('body[data-id="id_generalfeedback"]').innerHTML+=`<p>Consider these points: <span style="color: red;font-weight: bold;">${i.form.getFormValue("drags",[t-1,"label"])}</span> and <span style="color: red;font-weight: bold;">${i.form.getFormValue("drags",[o-1,"label"])}</span><br>
      They have a distance of <span style="color: red;font-weight: bold;">${p}.</span><br>
      Is that normal? If not, think about what that indicates.
      </p>`}else document.getElementById(`id_dd_${e}_distance`).value=""};for(let p=0;p<=25;++p)if(document.getElementById(`id_dd_${p}_point1`))document.getElementById(`id_dd_${p}_point1`).onchange=function(){l(p)},document.getElementById(`id_dd_${p}_point2`).onchange=function(){l(p)};else break;let g=function(e){let t=document.getElementById(`id_angles_${e}_point1`).value,o=document.getElementById(`id_angles_${e}_point2`).value,r=document.getElementById(`id_angles_${e}_point3`).value;if("0"!=t&&"0"!=o&&"0"!=r){let n=i.form.getFormValue("drops",[t-1,"coords"]).replace(/\s*/g,"").toString().split(",")[0],a=i.form.getFormValue("drops",[o-1,"coords"]).replace(/\s*/g,"").toString().split(",")[0],s=i.form.getFormValue("drops",[r-1,"coords"]).replace(/\s*/g,"").toString().split(",")[0],d=i.form.getFormValue("drops",[t-1,"coords"]).replace(/\s*/g,"").toString().split(",")[1].split(";"),l=i.form.getFormValue("drops",[o-1,"coords"]).replace(/\s*/g,"").toString().split(",")[1].split(";"),p=i.form.getFormValue("drops",[r-1,"coords"]).replace(/\s*/g,"").toString().split(",")[1].split(";"),g={x:parseFloat(a)-parseFloat(n),y:parseFloat(l)-parseFloat(d)},h={x:parseFloat(s)-parseFloat(a),y:parseFloat(p)-parseFloat(l)},c=g.x*h.x+g.y*h.y,f=Math.sqrt(g.x*g.x+g.y*g.y),u=Math.sqrt(h.x*h.x+h.y*h.y),v=180-180*Math.acos(c/(f*u))/Math.PI;"NaN"==v&&(v="0"),document.getElementById(`id_angles_${e}_angle`).value=v,document.getElementById("id_generalfeedback_ifr").contentDocument.querySelector('body[data-id="id_generalfeedback"]').innerHTML+=`<p>Consider these points: <span style="color: red;font-weight: bold;">${i.form.getFormValue("drags",[t-1,"label"])}</span>, <span style="color: red;font-weight: bold;">${i.form.getFormValue("drags",[o-1,"label"])}</span> and <span style="color: red;font-weight: bold;">${i.form.getFormValue("drags",[r-1,"label"])}</span><br>
      They have an angle between them of <span style="color: red;font-weight: bold;">${v}.</span><br>
      Is that normal? If not, think about what that indicates.
      </p>`}else document.getElementById(`id_angles_${e}_angle`).value=""};for(let h=0;h<=25;++h)if(document.getElementById(`id_angles_${h}_point1`))document.getElementById(`id_angles_${h}_point1`).onchange=function(){g(h)},document.getElementById(`id_angles_${h}_point2`).onchange=function(){g(h)},document.getElementById(`id_angles_${h}_point3`).onchange=function(){g(h)};else break;return{init:i.init}});